<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãµãŸã‚Šã®å®¶è¨ˆç°¿ - Happy Split</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');
        
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #fff9f0;
        }
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.05);
        }
        .btn-primary {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            transition: transform 0.2s;
        }
        .btn-primary:active {
            transform: scale(0.95);
        }
        .btn-success {
            background: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%);
        }
        .input-field {
            border: 2px solid #f3f4f6;
            border-radius: 12px;
            padding: 10px;
            outline: none;
            transition: border-color 0.3s;
        }
        .input-field:focus {
            border-color: #ff9a9e;
        }
        .user-a-bg { background-color: #fff0f0; }
        .user-b-bg { background-color: #f0f7ff; }
        .user-a-text { color: #ff6b6b; }
        .user-b-text { color: #4dabf7; }
        
        @keyframes bounce-subtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-bounce-subtle {
            animation: bounce-subtle 2s infinite;
        }

        /* Tabs styling */
        .tab-active {
            border-bottom: 3px solid #ff9a9e;
            color: #ff9a9e;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-md mx-auto">
        <!-- Notification Badge -->
        <div id="unsettled-alert" class="hidden mb-4 bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-3 rounded-r-lg flex items-center justify-between animate-bounce-subtle shadow-sm">
            <div class="flex items-center">
                <i class="fa-solid fa-triangle-exclamation mr-2"></i>
                <span class="text-xs font-bold">æœªç²¾ç®—ã®æ”¯å‡ºãŒã‚ã‚Šã¾ã™ï¼</span>
            </div>
            <span class="text-[10px] bg-orange-200 px-2 py-1 rounded-full">è¦ç¢ºèª</span>
        </div>

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-700">
                <i class="fa-solid fa-heart-pulse text-pink-400"></i> ãµãŸã‚Šã®å®¶è¨ˆç°¿
            </h1>
            <p class="text-gray-500 text-sm mt-2">ä»Šæœˆã‚‚ä»²è‰¯ãç®¡ç†ã—ã‚ˆã†ï¼</p>
        </header>

        <!-- Settlement Result -->
        <div id="settlement-card" class="card p-6 mb-8 border-2 border-pink-100 hidden relative overflow-hidden">
            <div id="settled-stamp" class="hidden absolute -right-4 -top-4 transform rotate-12 bg-green-500 text-white px-8 py-2 font-black text-xl shadow-lg z-10">
                ç²¾ç®—æ¸ˆã¿
            </div>
            <h2 class="text-lg font-bold mb-4 text-center text-gray-700">âœ¨ ä»Šæœˆã®ã¾ã¨ã‚</h2>
            <div id="settlement-details" class="space-y-4 text-center">
                <!-- Result injected here -->
            </div>
            <div id="settle-button-container" class="mt-4 border-t pt-4">
                <button onclick="completeSettlement()" class="w-full btn-success text-white font-bold py-2 rounded-xl shadow-md flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check-double"></i> ç²¾ç®—ã‚’å®Œäº†ã™ã‚‹
                </button>
            </div>
        </div>

        <!-- Inputs Section -->
        <div id="input-card" class="card p-6 mb-8">
            <h2 class="text-lg font-bold mb-4 flex items-center">
                <i class="fa-solid fa-plus-circle mr-2 text-pink-400"></i> å…¥åŠ›ã™ã‚‹
            </h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">ã ã‚ŒãŒï¼Ÿ</label>
                    <div class="flex gap-2">
                        <button onclick="setBuyer('A')" id="btn-user-a" class="flex-1 py-2 rounded-xl border-2 border-transparent bg-gray-100 transition-all font-bold">Aã•ã‚“</button>
                        <button onclick="setBuyer('B')" id="btn-user-b" class="flex-1 py-2 rounded-xl border-2 border-transparent bg-gray-100 transition-all font-bold">Bã•ã‚“</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">é‡‘é¡ (å††)</label>
                    <input type="number" id="amount" placeholder="0" class="w-full input-field text-xl font-bold">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">å†…å®¹</label>
                    <input type="text" id="note" placeholder="ã‚¹ãƒ¼ãƒ‘ãƒ¼ã€å¤–é£Ÿãªã©" class="w-full input-field">
                </div>
                <button onclick="addEntry()" class="w-full btn-primary text-white font-bold py-3 rounded-xl shadow-lg mt-2">è¿½åŠ ã™ã‚‹ï¼</button>
            </div>
        </div>

        <!-- Ratio Setting -->
        <div class="card p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-700">è² æ‹…æ¯”ç‡ã®èª¿æ•´</h2>
                <span id="ratio-display" class="font-bold text-pink-500">5 : 5</span>
            </div>
            <input type="range" id="ratio-slider" min="0" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-pink-400" oninput="updateRatio()">
            <div class="flex justify-between text-xs text-gray-400 mt-2">
                <span>Aã•ã‚“å¤šã‚</span>
                <span>åŒã˜</span>
                <span>Bã•ã‚“å¤šã‚</span>
            </div>
        </div>

        <!-- History Section with Tabs -->
        <div class="card p-6 mb-8">
            <div class="flex border-b mb-4">
                <button onclick="switchTab('current')" id="tab-current" class="flex-1 py-2 font-bold tab-active">ä»Šæœˆã®å±¥æ­´</button>
                <button onclick="switchTab('past')" id="tab-past" class="flex-1 py-2 font-bold text-gray-400">éå»ã®è¨˜éŒ²</button>
            </div>
            
            <!-- Current Month List -->
            <div id="current-month-section">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xs text-gray-400">ç¾åœ¨ã®æ”¯å‡ºä¸€è¦§</span>
                    <button onclick="clearHistory()" class="text-xs text-gray-400 underline">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
                <div id="history-list" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                    <p class="text-center text-gray-400 py-4">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>

            <!-- Past Archive List -->
            <div id="past-months-section" class="hidden">
                <div id="past-list" class="space-y-4 max-h-80 overflow-y-auto pr-2">
                    <p class="text-center text-gray-400 py-4">ä¿å­˜ã•ã‚ŒãŸè¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Celebration Overlay -->
    <div id="celebration" class="fixed inset-0 flex items-center justify-center bg-black/50 z-50 hidden">
        <div class="bg-white p-8 rounded-3xl text-center shadow-2xl transform transition-all scale-110">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">ç²¾ç®—å®Œäº†ï¼</h3>
            <p class="text-gray-600 mb-6">ãƒ‡ãƒ¼ã‚¿ã‚’éå»ã®è¨˜éŒ²ã«ä¿å­˜ã—ã¾ã—ãŸã€‚<br>ã‚¹ãƒƒã‚­ãƒªã—ã¾ã—ãŸã­ï¼</p>
            <button onclick="closeCelebration()" class="btn-primary text-white px-8 py-2 rounded-full font-bold">ã¨ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        let entries = [];
        let pastArchives = []; // Store past months data
        let currentBuyer = 'A';
        let ratioA = 0.5;
        let isSettled = false;

        function setBuyer(user) {
            currentBuyer = user;
            const btnA = document.getElementById('btn-user-a');
            const btnB = document.getElementById('btn-user-b');
            
            if (user === 'A') {
                btnA.classList.add('border-pink-400', 'user-a-bg', 'user-a-text');
                btnB.classList.remove('border-blue-400', 'user-b-bg', 'user-b-text');
            } else {
                btnB.classList.add('border-blue-400', 'user-b-bg', 'user-b-text');
                btnA.classList.remove('border-pink-400', 'user-a-bg', 'user-a-text');
            }
        }

        function updateRatio() {
            const val = document.getElementById('ratio-slider').value;
            const shareA = 10 - val;
            const shareB = val;
            ratioA = shareA / 10;
            
            document.getElementById('ratio-display').innerText = `${shareA} : ${shareB}`;
            if (isSettled) isSettled = false;
            calculate();
        }

        function addEntry() {
            const amountInput = document.getElementById('amount');
            const noteInput = document.getElementById('note');
            const amount = parseInt(amountInput.value);
            const note = noteInput.value || 'ç„¡é¡Œã®æ”¯å‡º';

            if (!amount || amount <= 0) return;

            const entry = {
                id: Date.now(),
                buyer: currentBuyer,
                amount: amount,
                note: note,
                date: new Date().toLocaleDateString('ja-JP', {month: '2-digit', day: '2-digit'}) + ' ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };

            entries.unshift(entry);
            amountInput.value = '';
            noteInput.value = '';
            
            isSettled = false;
            updateHistory();
            calculate();
        }

        function updateHistory() {
            const list = document.getElementById('history-list');
            if (entries.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 py-4">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            list.innerHTML = entries.map(e => `
                <div class="flex items-center justify-between p-3 rounded-xl ${e.buyer === 'A' ? 'user-a-bg' : 'user-b-bg'} ${isSettled ? 'opacity-60' : ''}">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold ${e.buyer === 'A' ? 'bg-pink-200 text-pink-600' : 'bg-blue-200 text-blue-600'}">
                            ${e.buyer}
                        </div>
                        <div>
                            <div class="text-sm font-bold text-gray-700">${e.note}</div>
                            <div class="text-[10px] text-gray-400">${e.date}</div>
                        </div>
                    </div>
                    <div class="font-bold text-gray-700">Â¥${e.amount.toLocaleString()}</div>
                </div>
            `).join('');
        }

        function calculate() {
            const alertBox = document.getElementById('unsettled-alert');
            const settleStamp = document.getElementById('settled-stamp');
            const settleBtnContainer = document.getElementById('settle-button-container');

            if (entries.length === 0) {
                document.getElementById('settlement-card').classList.add('hidden');
                alertBox.classList.add('hidden');
                return;
            }

            document.getElementById('settlement-card').classList.remove('hidden');

            const totalPaidA = entries.filter(e => e.buyer === 'A').reduce((sum, e) => sum + e.amount, 0);
            const totalPaidB = entries.filter(e => e.buyer === 'B').reduce((sum, e) => sum + e.amount, 0);
            const totalAmount = totalPaidA + totalPaidB;

            const targetA = totalAmount * ratioA;
            const diff = totalPaidA - targetA;

            const display = document.getElementById('settlement-details');
            let message = `<p class="text-sm text-gray-500">åˆè¨ˆæ”¯å‡º: <span class="font-bold text-gray-700">Â¥${totalAmount.toLocaleString()}</span></p>`;

            if (Math.round(diff) > 0) {
                message += `
                    <div class="py-2 px-4 bg-blue-50 rounded-lg inline-block w-full">
                        <p class="text-blue-600 font-bold text-lg">Bã•ã‚“ â†’ Aã•ã‚“</p>
                        <p class="text-3xl font-black text-blue-700">Â¥${Math.round(diff).toLocaleString()}</p>
                    </div>
                `;
            } else if (Math.round(diff) < 0) {
                message += `
                    <div class="py-2 px-4 bg-pink-50 rounded-lg inline-block w-full">
                        <p class="text-pink-600 font-bold text-lg">Aã•ã‚“ â†’ Bã•ã‚“</p>
                        <p class="text-3xl font-black text-pink-700">Â¥${Math.round(Math.abs(diff)).toLocaleString()}</p>
                    </div>
                `;
            } else {
                message += `<p class="font-bold text-green-500 py-4">ã´ã£ãŸã‚Šï¼æ¸…ç®—ã®å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“âœ¨</p>`;
            }

            display.innerHTML = message;

            if (isSettled) {
                alertBox.classList.add('hidden');
                settleStamp.classList.remove('hidden');
                settleBtnContainer.classList.add('hidden');
            } else {
                alertBox.classList.remove('hidden');
                settleStamp.classList.add('hidden');
                settleBtnContainer.classList.remove('hidden');
            }
        }

        function completeSettlement() {
            // Archive current data
            const totalPaidA = entries.filter(e => e.buyer === 'A').reduce((sum, e) => sum + e.amount, 0);
            const totalPaidB = entries.filter(e => e.buyer === 'B').reduce((sum, e) => sum + e.amount, 0);
            const totalAmount = totalPaidA + totalPaidB;
            const shareA = 10 - document.getElementById('ratio-slider').value;
            const shareB = 10 - shareA;

            const archive = {
                month: new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' }),
                total: totalAmount,
                ratio: `${shareA}:${shareB}`,
                entries: [...entries],
                settlement: document.getElementById('settlement-details').innerHTML,
                timestamp: Date.now()
            };

            pastArchives.unshift(archive);
            isSettled = true;
            document.getElementById('celebration').classList.remove('hidden');
            
            // Clear current inputs for "next month"
            entries = []; 
            updateHistory();
            calculate();
            updatePastArchives();
        }

        function updatePastArchives() {
            const list = document.getElementById('past-list');
            if (pastArchives.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 py-4">ä¿å­˜ã•ã‚ŒãŸè¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            list.innerHTML = pastArchives.map((archive, index) => `
                <div class="border-2 border-gray-100 rounded-2xl p-4 bg-white shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-gray-700">${archive.month}</span>
                        <span class="text-[10px] bg-green-100 text-green-600 px-2 py-1 rounded-full font-bold">ç²¾ç®—æ¸ˆã¿</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-500 mb-3">
                        <span>åˆè¨ˆ: Â¥${archive.total.toLocaleString()}</span>
                        <span>æ¯”ç‡: ${archive.ratio}</span>
                    </div>
                    <details class="text-xs">
                        <summary class="cursor-pointer text-blue-400 underline mb-2">è©³ç´°ãƒ»å†…è¨³ã‚’è¦‹ã‚‹</summary>
                        <div class="mt-2 space-y-1 border-t pt-2 opacity-70">
                            ${archive.entries.map(e => `
                                <div class="flex justify-between">
                                    <span>${e.buyer}: ${e.note}</span>
                                    <span>Â¥${e.amount.toLocaleString()}</span>
                                </div>
                            `).join('')}
                            <div class="mt-3 p-2 bg-gray-50 rounded text-center scale-90">
                                ${archive.settlement}
                            </div>
                        </div>
                    </details>
                </div>
            `).join('');
        }

        function switchTab(tab) {
            const currentTabBtn = document.getElementById('tab-current');
            const pastTabBtn = document.getElementById('tab-past');
            const currentSection = document.getElementById('current-month-section');
            const pastSection = document.getElementById('past-months-section');

            if (tab === 'current') {
                currentTabBtn.classList.add('tab-active');
                currentTabBtn.classList.remove('text-gray-400');
                pastTabBtn.classList.remove('tab-active');
                pastTabBtn.classList.add('text-gray-400');
                currentSection.classList.remove('hidden');
                pastSection.classList.add('hidden');
            } else {
                pastTabBtn.classList.add('tab-active');
                pastTabBtn.classList.remove('text-gray-400');
                currentTabBtn.classList.remove('tab-active');
                currentTabBtn.classList.add('text-gray-400');
                pastSection.classList.remove('hidden');
                currentSection.classList.add('hidden');
                updatePastArchives();
            }
        }

        function closeCelebration() {
            document.getElementById('celebration').classList.add('hidden');
        }

        function clearHistory() {
            if(confirm('ä»Šæœˆã®æœªç²¾ç®—ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿï¼ˆéå»ã®è¨˜éŒ²ã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰')) {
                entries = [];
                isSettled = false;
                updateHistory();
                calculate();
            }
        }

        setBuyer('A');
    </script>
</body>
</html>